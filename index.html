<!DOCTYPE html>
<html>
<head>
<title>Spacer by Nircek</title>
<style>
div[center] {
	text-align: center;
	font-weight: 800;
	font-family: monospace;
}
body {
	background-color: #aaa;
}
</style>
<script>
String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};
function getCookie(cname) {
	// https://www.w3schools.com/js/js_cookies.asp
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "0";
}
ivls = []
best_sc = getCookie('best');
points = 0;
iterator = 0;
double = false;
SPACE=32;
LEFT=37;
RIGHT=39;
HEIGHT=10;
WIDTH=20;
started=false;
els=[];
pos=0;
function onload(){
	body  = document.getElementById('body');
	title = document.getElementById('title');
	scene = document.getElementById('scene');
	best  = document.getElementById('best');
	p     = document.getElementById('p');
	hint  = document.getElementById('hint');
	ivls=ivls.concat(setInterval(main, 1000));
	//startGame();
}
function main(){
	iterator++;
	if(iterator==1){
		title.innerHTML = 'SPACER v0.0';
	}else if(iterator==4){
		scene.innerHTML = 'Loading...';
	}else if(iterator>4&&iterator<8){
		scene.innerHTML = scene.innerHTML.substr(0,scene.innerHTML.length-1);
	}else if(iterator==9){
		if(!double){
			double = true;
			scene.innerHTML = 'Loading...';
			iterator = 4;
			return;
		}
		best.innerHTML = 'Your best score is '+best_sc+'.';
		scene.innerHTML = ' ';
		p.innerHTML = '';
	}else if(iterator==10){
		scene.innerHTML = "To start a game, press [SPACE].";
		iterator = 8;
		body.onkeydown=function(e){
			if(!e.metaKey){e.preventDefault();}
			switch(e.keyCode){
				case SPACE:startGame();break;
				case LEFT:pos--;break;
				case RIGHT:pos++;break;
				case 68: best_sc=0;
				default:e.preventDefault();break;
			}
			pos=(WIDTH+pos)%WIDTH;
			if(started)
				setScene();
		}
	}
}
function startGame(){
	started=true;
	for(i=0;i<ivls.length;++i)
		clearInterval(ivls[i]);
	scene.innerHTML = '';
	best.innerHTML = '';
	hint.innerHTML = '<span>Use your arrow keys on your keyboard to move.</span>';
	setScene();
	ivls=ivls.concat(setInterval(mainLoop,1000));
	els=[];
	ivls=ivls.concat(setInterval(randomPoint,3000));
}
function setScene() {
	p.innerHTML = points;
	arr = Array(HEIGHT);
	for(i=0;i<arr.length;++i)
		arr[i]=Array(WIDTH).fill(' ').concat('\r\n');
	for(i=0;i<els.length;++i)
		arr[els[i].y][els[i].x] = els[i].t;
	arr[HEIGHT-1][pos]='@';
	scene.innerHTML = arr.toString().replaceAll(',','');
}
function shift(){
	for(i=0;i<els.length;++i) {
		els[i].y += 1;
		if(els[i].y>=HEIGHT-1) {
			if(els[i].x==pos) points += 1;
			else gameOver();
			els.splice(i,1);
		}
	}
}
function randomPoint(){
	els=els.concat({y:0,x:Math.floor((Math.random() * (WIDTH-1))),t:'X'})
}
function mainLoop(){
	shift();
	setScene();
}
function gameOver(){
	started=false;
	setScene();
	alert('Game over!');
	for(i=0;i<ivls.length;++i)
		clearInterval(ivls[i]);
	iterator = 8;
	if(points>best_sc)best_sc=points;
	document.cookie = "best="+best_sc
	points=0;
	ivls=ivls.concat(setInterval(main, 1000));
}
</script>
</head>
<body onload="onload()" id="body">
<div center>
<pre>
<div id="title">LOADING</div>
<br><div id="best"></div><br>
<div id="scene"></div>
<div id ="p"></div>
<div id ="hint"></div>
</pre>
<h6><a href="https://github.com/Nircek/spacer">Spacer v0.0 by Nircek (MIT license)</a></h6>
</div>
</body>
</html>
